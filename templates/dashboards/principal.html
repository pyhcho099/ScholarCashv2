{% extends "base.html" %}

{% block content %}
<style>
    .pri-page { max-width: 1200px; margin: 0 auto; }

    .pri-title { margin: 0 0 24px; display: flex; align-items: center; gap: 12px; }
    .pri-title h2 { margin: 0; }

    /* Mint / Budget Banner */
    .pri-mint-banner {
        background: var(--color-warning-bg);
        border: 1.5px solid var(--color-warning-border);
        padding: 28px;
        border-radius: var(--radius-xl);
        margin-bottom: 28px;
    }
    .pri-mint-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 20px;
    }
    .pri-mint-top h3 { margin: 0; color: var(--color-accent-amber); display: flex; align-items: center; gap: 8px; }
    .pri-mint-top p { margin: 4px 0 0; color: var(--color-warning); font-size: 0.88em; }
    .pri-circ-stat { text-align: right; }
    .pri-circ-stat h1 {
        margin: 0;
        font-size: 2.4em;
        color: var(--color-accent-amber);
        font-weight: 800;
        letter-spacing: -0.03em;
        line-height: 1.1;
        font-family: var(--font-mono);
    }
    .pri-circ-stat span { font-size: 0.72em; color: var(--color-warning); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }

    .pri-mint-form {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    .pri-mint-form .field { flex: 2; min-width: 220px; }
    .pri-mint-form .field-sm { flex: 1; min-width: 100px; }
    .pri-mint-form label { font-size: 0.8em; margin-bottom: 4px; color: var(--color-warning); }
    .pri-mint-form input, .pri-mint-form select {
        margin: 0;
        padding: 10px 12px;
        border: 1.5px solid var(--color-warning-border);
    }
    .pri-mint-form input:focus, .pri-mint-form select:focus {
        border-color: var(--color-accent-amber);
        box-shadow: 0 0 0 3px rgba(217,119,6,0.1);
    }
    .pri-mint-form button {
        background: var(--color-accent-amber);
        padding: 10px 24px;
        width: auto;
        white-space: nowrap;
        font-weight: 700;
        letter-spacing: 0.02em;
    }
    .pri-mint-form button:hover { background: #b45309; }

    .pri-divider {
        border: 0;
        border-top: 1px solid var(--color-border);
        margin: 32px 0;
    }

    /* Two-col layout */
    .pri-two-col {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }
    .pri-col {
        flex: 1;
        min-width: 320px;
        background: var(--color-surface);
        padding: 24px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border);
    }
    .pri-col h3 { margin: 0 0 16px; display: flex; align-items: center; gap: 8px; }
    .pri-col h4 { margin: 20px 0 12px; color: var(--color-text-secondary); font-size: 0.9em; }

    .pri-mini-form {
        background: var(--color-surface-sunken);
        padding: 16px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
    }
    .pri-mini-form label { font-size: 0.82em; margin-bottom: 4px; }
    .pri-mini-form input, .pri-mini-form select { margin: 0 0 12px; padding: 9px 12px; }
    .pri-mini-form button { padding: 9px 16px; width: auto; }

    .pri-list-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--color-border);
    }
    .pri-list-row:last-child { border-bottom: none; }
    .pri-list-row td, .pri-list-row th { border: none; }

    .pri-action-link {
        text-decoration: none;
        font-weight: 500;
        font-size: 0.85em;
        transition: opacity var(--transition-fast);
    }
    .pri-action-link:hover { opacity: 0.7; }

    /* Staff form */
    .pri-staff-form {
        background: #eef2ff;
        padding: 20px;
        border-radius: var(--radius-md);
        border: 1px solid #c7d2fe;
    }
    .pri-staff-form label { font-size: 0.82em; margin-bottom: 4px; }
    .pri-staff-form input, .pri-staff-form select { margin: 0 0 12px; padding: 9px 12px; }
    .pri-staff-form button { padding: 9px 16px; margin-top: 4px; }

    /* Role badges in staff list */
    .pri-role-badge {
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.72em;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .pri-role-badge.hod { background: var(--color-accent-purple); }
    .pri-role-badge.tutor { background: var(--color-accent-blue); }
    .pri-role-badge.teacher { background: var(--color-primary); }

    /* Store section */
    .pri-store-section {
        background: var(--color-surface);
        padding: 24px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border);
    }
    .pri-store-section h3 { margin: 0 0 8px; display: flex; align-items: center; gap: 8px; }

    .pri-store-form {
        background: #fff7ed;
        padding: 18px;
        border-radius: var(--radius-md);
        border: 1px solid #ffedd5;
        margin-top: 12px;
    }
    .pri-store-form .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .pri-store-form .form-row > div { flex: 2; min-width: 140px; }
    .pri-store-form .form-row > div:nth-child(2),
    .pri-store-form .form-row > div:nth-child(3) { flex: 1; min-width: 100px; }
    .pri-store-form label { font-size: 0.82em; margin-bottom: 4px; }
    .pri-store-form input { margin: 0; padding: 9px 12px; }
    .pri-store-form button {
        background: #ea580c;
        margin-top: 12px;
        padding: 9px 20px;
        width: auto;
    }
    .pri-store-form button:hover { background: #c2410c; }

    .pri-filter-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .pri-filter-bar h4 { margin: 0; }
    .pri-filter-controls { display: flex; gap: 10px; flex-wrap: wrap; }
    .pri-filter-controls input, .pri-filter-controls select {
        padding: 8px 12px;
        border: 1.5px solid var(--color-border);
        margin: 0;
        width: auto;
        min-width: 140px;
        font-size: 0.85em;
    }

    .pri-stock-ok { color: var(--color-success); font-weight: 600; }
    .pri-stock-low { color: var(--color-accent-amber); font-weight: 700; }
    .pri-stock-out { color: var(--color-danger); font-weight: 700; }

    @media (max-width: 768px) {
        .pri-mint-form { flex-direction: column; }
        .pri-two-col { flex-direction: column; }
        .pri-col { min-width: 100%; }
        .pri-filter-bar { flex-direction: column; align-items: flex-start; }
        .pri-mint-top { flex-direction: column; text-align: left; }
        .pri-circ-stat { text-align: left; }
    }
</style>

<div class="pri-page">

    <div class="pri-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent-amber)" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <h2>Principal's Dashboard</h2>
    </div>

    <!-- Budget / Mint Section -->
    <div class="pri-mint-banner">
        <div class="pri-mint-top">
            <div>
                <h3>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    Budget Allocation
                </h3>
                <p>Distribute coins to HODs and Teachers for the month.</p>
            </div>
            <div class="pri-circ-stat">
                <h1>{{ circulation }}</h1>
                <span>Coins in Circulation</span>
            </div>
        </div>

        <form action="/principal/mint" method="POST" class="pri-mint-form">
            <div class="field">
                <label>Select Staff Member</label>
                <select name="user_id" required>
                    <option value="">-- Choose Recipient --</option>
                    <optgroup label="Heads of Department (HOD)">
                        {% for s in staff if s.role == 'hod' %}
                        <option value="{{ s.id }}">{{ s.name }} ({{ s.branch.name }} Dept)</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Class Tutors">
                        {% for s in staff if s.role == 'tutor' %}
                        <option value="{{ s.id }}">{{ s.name }} (Class Tutor)</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Teachers">
                        {% for s in staff if s.role == 'teacher' %}
                        <option value="{{ s.id }}">{{ s.name }} (Subject Teacher)</option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
            <div class="field-sm">
                <label>Amount</label>
                <input type="number" name="amount" placeholder="500" required>
            </div>
            <div class="field">
                <label>Reason / Month</label>
                <input type="text" name="reason" placeholder="Feb Budget" required>
            </div>
            <button type="submit">SEND COINS</button>
        </form>
    </div>

    <hr class="pri-divider">

    <!-- Branch & Class Creation -->
    <div class="pri-two-col">
        <div class="pri-col">
            <h3>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-secondary)" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                Create Branch
            </h3>
            <div class="pri-mini-form">
                <form action="/principal/add_branch" method="POST">
                    <label>Branch Name (e.g., Science)</label>
                    <input type="text" name="name" placeholder="Enter Branch Name" required>
                    <button type="submit">Add Branch</button>
                </form>
            </div>

            <h4>Existing Branches</h4>
            <div>
                {% for b in branches %}
                <div class="pri-list-row">
                    <span style="font-weight: 500; color: var(--color-text);">{{ b.name }}</span>
                    <span>
                        <a href="/edit/branch/{{ b.id }}" class="pri-action-link" style="color: var(--color-accent-blue); margin-right: 12px;">Edit</a>
                        <a href="/delete/branch/{{ b.id }}" class="pri-action-link" style="color: var(--color-danger);" onclick="return confirm('Delete this branch?');">Delete</a>
                    </span>
                </div>
                {% else %}
                <p style="color: var(--color-text-muted); font-size: 0.9em; padding: 12px 0;">No branches yet.</p>
                {% endfor %}
            </div>
        </div>

        <div class="pri-col">
            <h3>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-secondary)" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                Create Class
            </h3>
            <div class="pri-mini-form">
                <form action="/principal/add_class" method="POST">
                    <label>Class Name (e.g., 10-A)</label>
                    <input type="text" name="name" placeholder="Enter Class Name" required>
                    <label>Select Branch</label>
                    <select name="branch_id" required>
                        {% for b in branches %}
                        <option value="{{ b.id }}">{{ b.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Add Class</button>
                </form>
            </div>

            <h4>Existing Classes</h4>
            <div>
                {% for c in classes %}
                <div class="pri-list-row">
                    <span>
                        <span style="font-weight: 500; color: var(--color-text);">{{ c.name }}</span>
                        <small style="color: var(--color-text-muted); margin-left: 6px;">({{ c.branch.name }})</small>
                    </span>
                    <span>
                        <a href="/edit/class/{{ c.id }}" class="pri-action-link" style="color: var(--color-accent-blue); margin-right: 12px;">Edit</a>
                        <a href="/delete/class/{{ c.id }}" class="pri-action-link" style="color: var(--color-danger);" onclick="return confirm('Delete this class?');">Delete</a>
                    </span>
                </div>
                {% else %}
                <p style="color: var(--color-text-muted); font-size: 0.9em; padding: 12px 0;">No classes yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Staff Management -->
    <div class="pri-two-col" style="margin-top: 28px;">
        <div class="pri-col">
            <h3>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-secondary)" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                Add Staff / Students
            </h3>
            <div class="pri-staff-form">
                <form action="/principal/add_staff" method="POST">
                    <label>Full Name</label>
                    <input type="text" name="name" placeholder="John Doe" required>

                    <label>Email (Login ID)</label>
                    <input type="email" name="email" placeholder="user@school.com" required>

                    <label>Password</label>
                    <input type="text" name="password" placeholder="Set Password" required>

                    <label>Role</label>
                    <select name="role" id="roleSelect" onchange="toggleFields()">
                        <option value="teacher">Subject Teacher</option>
                        <option value="tutor">Class Tutor</option>
                        <option value="hod">Head of Dept (HOD)</option>
                    </select>

                    <div id="branchField" style="display: block;">
                        <label style="color: var(--color-accent-blue);">Select Department/Branch</label>
                        <select name="branch_id">
                            <option value="">-- Choose Branch --</option>
                            {% for b in branches %}
                            <option value="{{ b.id }}">{{ b.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="classField" style="display: none;">
                        <label id="classLabel" style="color: var(--color-primary);">Select Class</label>
                        <select name="class_id">
                            <option value="">-- Choose Class (Skip if not a Tutor) --</option>
                            {% for c in classes %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit">Create User</button>
                </form>
            </div>

            <script>
            function toggleFields() {
                var role = document.getElementById("roleSelect").value;
                var branchDiv = document.getElementById("branchField");
                var classDiv = document.getElementById("classField");
                var classLabel = document.getElementById("classLabel");

                branchDiv.style.display = 'none';
                classDiv.style.display = 'none';

                if (role === 'tutor') {
                    classDiv.style.display = 'block';
                    classLabel.innerText = "Assign Class (Required):";
                }
                else if (role === 'hod') {
                    branchDiv.style.display = 'block';
                    classDiv.style.display = 'block';
                    classLabel.innerText = "Assign Class (Optional - if also a Tutor):";
                }
                else if (role === 'teacher') {
                    branchDiv.style.display = 'block';
                }
            }
            window.onload = toggleFields;
            </script>
        </div>

        <div class="pri-col">
            <h3>Staff List</h3>
            <div style="overflow-x: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                <table>
                    <thead>
                        <tr>
                            <th style="padding: 10px 14px;">Name</th>
                            <th style="padding: 10px 14px;">Role</th>
                            <th style="padding: 10px 14px;">Department/Class</th>
                            <th style="padding: 10px 14px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in staff if s.role in ['teacher', 'tutor', 'hod'] %}
                        <tr>
                            <td style="font-weight: 500; color: var(--color-text);">{{ s.name }}</td>
                            <td>
                                {% if s.role == 'hod' %}
                                <span class="pri-role-badge hod">HOD</span>
                                {% elif s.role == 'tutor' %}
                                <span class="pri-role-badge tutor">TUTOR</span>
                                {% else %}
                                <span class="pri-role-badge teacher">TEACHER</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 0.88em;">
                                {% if s.branch %}
                                    {{ s.branch.name }}
                                {% endif %}
                                {% if s.tutor_of_class %}
                                    {% for c in s.tutor_of_class %}
                                        <br><small style="color: var(--color-text-muted);">({{ c.name }})</small>
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                <a href="/edit/user/{{ s.id }}" class="pri-action-link" style="color: var(--color-accent-blue);">Edit</a>
                                <span style="color: var(--color-border); margin: 0 6px;">|</span>
                                <a href="/delete/user/{{ s.id }}" class="pri-action-link" style="color: var(--color-danger);" onclick="return confirm('Remove this user?');">Delete</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="padding: 24px; text-align: center; color: var(--color-text-muted);">No staff members yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Store Management -->
    <div class="pri-store-section" style="margin-top: 28px;">
        <h3>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-secondary)" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            Manage School Store
        </h3>
        <p style="color: var(--color-text-muted); font-size: 0.88em; margin: 0 0 4px;">Add items that students can buy with their coins.</p>

        <div class="pri-store-form">
            <form action="/principal/add_item" method="POST">
                <div class="form-row">
                    <div>
                        <label>Item Name</label>
                        <input type="text" name="name" placeholder="e.g. Notebook, Pizza" required>
                    </div>
                    <div>
                        <label>Cost (Coins)</label>
                        <input type="number" name="cost" placeholder="50" required>
                    </div>
                    <div>
                        <label>Stock Qty</label>
                        <input type="number" name="stock" placeholder="100" required>
                    </div>
                </div>
                <button type="submit">Add to Store</button>
            </form>
        </div>

        <!-- Filterable Inventory -->
        <div style="margin-top: 28px;">
            <div class="pri-filter-bar">
                <h4>Current Inventory</h4>
                <div class="pri-filter-controls">
                    <input type="text" id="searchInput" placeholder="Search by name..." onkeyup="filterTable()">
                    <select id="stockFilter" onchange="filterTable()">
                        <option value="all">All Stock</option>
                        <option value="low">Low Stock ({'<'} 5)</option>
                        <option value="out">Out of Stock</option>
                        <option value="available">In Stock</option>
                    </select>
                    <select id="costFilter" onchange="filterTable()">
                        <option value="all">All Prices</option>
                        <option value="0-50">0-50 coins</option>
                        <option value="51-100">51-100 coins</option>
                        <option value="101+">101+ coins</option>
                    </select>
                </div>
            </div>

            <div style="overflow-x: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th style="padding: 10px 14px;">Item</th>
                            <th style="padding: 10px 14px; text-align: center;">Cost</th>
                            <th style="padding: 10px 14px; text-align: center;">Stock</th>
                            <th style="padding: 10px 14px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in store_items %}
                        <tr class="inventory-row" data-name="{{ item.name|lower }}" data-cost="{{ item.cost }}" data-stock="{{ item.stock }}">
                            <td style="font-weight: 500; color: var(--color-text);">{{ item.name }}</td>
                            <td style="text-align: center; font-family: var(--font-mono); font-weight: 600;">{{ item.cost }}</td>
                            <td style="text-align: center;">
                                {% if item.stock == 0 %}
                                    <span class="pri-stock-out">Out of Stock</span>
                                {% elif item.stock < 5 %}
                                    <span class="pri-stock-low">{{ item.stock }} (Low)</span>
                                {% else %}
                                    <span class="pri-stock-ok">{{ item.stock }}</span>
                                {% endif %}
                            </td>
                            <td style="text-align: center;">
                                <a href="/edit/store/{{ item.id }}" class="pri-action-link" style="color: var(--color-accent-blue); margin-right: 12px;">Edit</a>
                                <a href="/delete/store/{{ item.id }}" class="pri-action-link" style="color: var(--color-danger);" onclick="return confirm('Delete {{ item.name }}?');">
                                    Remove
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr id="emptyRow">
                            <td colspan="4" style="text-align: center; padding: 24px; color: var(--color-text-muted);">No items in store. Add your first item above!</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
function filterTable() {
    var searchInput = document.getElementById("searchInput").value.toLowerCase();
    var stockFilter = document.getElementById("stockFilter").value;
    var costFilter = document.getElementById("costFilter").value;
    var rows = document.getElementsByClassName("inventory-row");
    var visibleCount = 0;

    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var name = row.getAttribute("data-name");
        var cost = parseInt(row.getAttribute("data-cost"));
        var stock = parseInt(row.getAttribute("data-stock"));

        var showRow = true;

        if (searchInput && !name.includes(searchInput)) {
            showRow = false;
        }

        if (stockFilter === "low" && stock >= 5) {
            showRow = false;
        } else if (stockFilter === "out" && stock !== 0) {
            showRow = false;
        } else if (stockFilter === "available" && stock === 0) {
            showRow = false;
        }

        if (costFilter === "0-50" && (cost < 0 || cost > 50)) {
            showRow = false;
        } else if (costFilter === "51-100" && (cost < 51 || cost > 100)) {
            showRow = false;
        } else if (costFilter === "101+" && cost < 101) {
            showRow = false;
        }

        if (showRow) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    }

    var emptyRow = document.getElementById("emptyRow");
    if (emptyRow) {
        if (visibleCount === 0 && rows.length > 0) {
            emptyRow.style.display = "";
            emptyRow.cells[0].innerText = "No items match your filters.";
        } else {
            emptyRow.style.display = "none";
        }
    }
}
</script>
{% endblock %}
